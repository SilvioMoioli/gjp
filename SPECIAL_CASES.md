# Special cases

## Failing dry-runs

If your build fails for whatever reason during a dry run, abort it with `^C^D` (`Ctrl+C` followed by `Ctrl+D`). `tetra` will restore all project files as they were before the build.

## Generating files multiple times

You can edit any file generated by tetra - regenerating it later will not overwrite your changes.

`tetra` will try to reconcile your edits with a [three-way merge](http://en.wikipedia.org/wiki/Three-way_merge#Three-way_merge) - if that fails you will be warned about any conflicts.

You can generate single files with the following commands:

* `tetra generate-script`: (re)generates the `build.sh` file from commands used in the latest successful dry-run;
* `tetra generate-archive`: (re)generates the package tarball;
* `tetra generate-spec`: (re)generates the package spec;
* `tetra generate-kit`: (re)generates the kit tarball and spec;

## Patches

If you need to modify your project's sources for whatever reason, feel free to do so and then use `tetra patch "my patch message"` to signal your changes.

After that you can retry the dry-run and spec generation: tetra will take care of creating patch files and adding `%patch` instructions for you.

In case you want to swap sources completely and throw away all previous patches use `tetra patch --new-tarball`.

## Ant builds

Ant is supported as well as Maven. You have a prebundled copy in `kit`, and using `ant` from a dry-run will use that by default.

Sometimes you will have jar files distributed along with the source archive that will end up in `src/`: you don't want that! Run:

    tetra move-jars-to-kit

to have them moved to `kit/jars`. The command will generate symlinks back to the originals, so builds will work as expected.

When generating spec files, it helps to have a `pom.xml` in your package directory even if you are not using Maven, as `tetra` will automatically take advantage of information from it to compile many fields, but it's not required.

You can also ask `tetra` to find one via `tetra get-pom <filename>.jar`.

## Use different Ant or Maven versions

In case the bundled Ant or Maven versions are not usable in your project for whatever reason and you want to bundle a different one, just remove their directories from `kit` and replace them with your own. `tetra` will look for binaries named `ant` or `mvn` in kit and use them wherever they are found.

You can also use system-provided Ant and Maven by simply deleting their directories from `kit/`. Note that this is not recommended because a different version might be used at build time (for example in OBS), potentially resulting in non-reproducible builds.

## Other build tools

Other build tools are currently not supported out-of-the-box but you can still use them with some manual tweaking. You should basically make sure that:

 - a copy of their executables and libraries is stored and gets called from `kit/`
 - all files automatically downloaded during the build are also stored in `kit`.

Tool-specific instructions for most popular tools follow.

### ivy

Assuming ivy is used by ant:
 * during your dry-run build, add the `-Divy.default.ivy.user.dir=<PATH_TO_PROJECT>/kit/ivy` commandline option to `ant` in order to download files in the `kit` directory;
 * after your build script is generated, replace the path to your project with `$PROJECT_PREFIX` in `build.sh` to ensure the build will not need Internet access.

### sbt

Instructions:
 * before starting your dry-run build, copy a binary release to a subdirectory in `kit/`, for example `kit/sbt/`;
 * during your dry-run build, add the `-Dsbt.global.base=../../kit/sbt-global-base` commandline option to `sbt` in order to download files in the `kit` directory;
 * if your build also uses Ivy, add `-Dsbt.ivy.home=../../kit/ivy2` as well;
 * after your build script is generated, add the `"set offline := true"` commandline option to `sbt` to `build.sh` to ensure the build will not need Internet access.

### gradle

Assuming your project uses the [Gradle Wrapper](http://gradle.org/docs/current/userguide/gradle_wrapper.html);

 * during your dry-run build, add the `--gradle-user-home /tmp/gradle --project-cache-dir /tmp/gradle-project` commandline options to `gradlew` in order to download files in the `/tmp` directory instead of your home
 * after the build has finished but prior ending the dry-run, copy all files to your kit with:

      cp -r /tmp/gradle* kit/

 * after your build script is generated, add the following line to `build.sh` in order to restore files from `kit/` to `/tmp`:
      cp -r /tmp/gradle* kit/

 * furthermore, add the `--gradle-user-home /tmp/gradle --project-cache-dir /tmp/gradle-project --offline` commandline options to `gradlew` in `build.sh` to ensure the build will not need Internet access.

Note that you cannot put files in `kit/` directly because your build would break on relocation, see [GRADLE-2690](https://issues.gradle.org/browse/GRADLE-2690).

## [OBS](build.opensuse.org) integration

If you want to submit your package to OBS, you can do so by copying contents of the `packages` in a proper OBS project directory.

Packages will rebuild cleanly in OBS because no Internet access is needed - all files were already downloaded during dry-run and are included in the kit.

Note that the kit packages is only needed at build time by OBS, no end user should ever install it, so you can place it in a non-public project/repository if you so wish.

## Gotchas

* `tetra` internally uses `git` to keep track of files, any tetra project is actually also a `git` repo. Feel free to use it as any ordinary git repo, including pushing to a remote repo, rebasing, merging or using GitHub's pull requests. Just make sure any `tetra: ` comments are preserved;
* some Maven plugins like the Eclipse Project ones ([Tycho](https://www.eclipse.org/tycho/)) will save data in `/tmp` downloaded from the Internet and will produce errors if this data is not there during offline builds. One way to work around that is to force Java to use a kit subdirectory as `/tmp`. Add the following option to `mvn` during your build:

    -Djava.io.tmpdir=<full path to project>/kit/tmp

Use the following option in `mvn` in your build.sh file to make it reproducible:

    -Djava.io.tmpdir=$PROJECT_PREFIX/kit/tmp

* Tycho builds may also require NSS, so if you get NSS errors be sure to add `mozilla-nss` or an equivalent package in a BuildRequires: line;
* some badly designed testsuites might not work in OBS. If you are using `mvn` you can add the following option to disable them:

   -DskipTests=true

* if you want to be 100% sure your package builds without network access, you can use scripts in the `utils/` folder to create a special `nonet` user that cannot use the Internet and retry the build from that user.
